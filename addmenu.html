<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="menu.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script src="firebase.js"></script> 
</head>

<body>
    <section class="subscription flex-center">
        <div class="login-herocontent">
            <h2>Menu</h2>

            <div class="menu-container"></div>

        </div>
    </section>

    <script>
        const app = firebase.initializeApp({
            apiKey: "AIzaSyDImyxdSlB0Yr0PdMx32nVccGt7n3zMWZw",
            authDomain: "gharvedtan-auth.firebaseapp.com",
            projectId: "gharvedtan-auth",
            storageBucket: "gharvedtan-auth.firebasestorage.app",
            messagingSenderId: "32502650170",
            appId: "1:32502650170:web:8268b4c5947d5f04ab6c03"
        });

        const db = firebase.firestore(app);
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (!user) {
                console.log("User not authenticated, redirecting to login...");
                window.location.href = '/login.html';  
            } else {
                console.log("User authenticated:", user);
            }
        });

        async function addToCart(userId) {
            const itemName = "Chingri Malai Curry";  
            const price = 300;  
            const itemData = {
                name: itemName,
                price: price,
                quantity: 1
            };

            const cartRef = db.collection('users').doc(userId).collection('carts').doc('cartId');
            const cartDoc = await cartRef.get();

            if (!cartDoc.exists) {
                await cartRef.set({
                    items: [itemData]
                });
            } else {
                const cartData = cartDoc.data();
                const cartItems = cartData.items || [];
                const itemIndex = cartItems.findIndex(item => item.name === itemName);
                if (itemIndex === -1) {
                    cartItems.push(itemData);
                } else {
                    cartItems[itemIndex].quantity += 1;
                }

                await cartRef.update({
                    items: cartItems
                });
            }

            alert('Item added to cart!');
        }

        async function fetchAndDisplayItems() {
            try {
                const menuSnapshot = await db.collection('menu').get(); 
                const menuItems = menuSnapshot.docs.map(doc => doc.data());

                menuItems.forEach(item => {
                    const menuDiv = document.createElement('div');
                    menuDiv.classList.add('menu-item');
                    menuDiv.innerHTML = `
                        <img src="${item.photoUrl}" alt="${item.name}" />
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <p>${item.description}</p>
                            <span>⭐ ${item.rating}</span>
                            <span>₹${item.price}</span>
                            <button class="addToCartBtn" data-item-id="${item.id}">Add to Cart</button>
                        </div>
                    `;
                    document.querySelector('.menu-container').appendChild(menuDiv);

                  
                    document.querySelector(`.addToCartBtn[data-item-id="${item.id}"]`).addEventListener('click', () => {
                        addToCart(item.id); 
                    });
                });
            } catch (error) {
                console.error('Error fetching items:', error);
            }
        }

        fetchAndDisplayItems(); 
    </script>
</body>

</html>
