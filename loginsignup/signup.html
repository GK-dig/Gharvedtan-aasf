<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signup | GharVEDtan</title>
  <link rel="stylesheet" href="signup.css" />
  <link rel="stylesheet" href="../dist/aos.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <header>
    <nav class="header__nav">
      <div class="header__logo">
        <h4 data-aos="fade-down">GHARVEDTAN</h4>
        <div class="header__logo-overlay"></div>
      </div>
      <ul class="header__menu" data-aos="fade-down">
        <li><a href="../loginsignup/work.html">Login</a></li>
        <li><a href="../index.html">Back</a></li>
      </ul>
    </nav>
  </header>
  <section class="subscription flex-center">
    <div class="login-herocontent">
      <h2 data-aos="flip-down">Signup</h2>

      <div class="subscription__form" data-aos="fade-up">
        <input type="text" id="signupName" placeholder="Enter Name" required />
      </div>

      <div class="subscription__form" data-aos="fade-up">
        <input type="password" id="signupPass" placeholder="Enter Password" required />
      </div>
      
      <div class="subscription__form" data-aos="fade-up">
        <input type="password" id="signupRepass" placeholder="Re-enter password" required />
      </div>

      <div class="form-group" data-aos="fade-up">
        <div class="location-selector">
          <p class="location-display">
            Selected Location: <span id="city-name">None</span>
            <button type="button" id="clear-city-btn" class="btn-clear" title="Clear Selection">
              <i class="fas fa-times"></i>
            </button>
          </p>
          <div id="location-details" style="display: none; font-size: 0.8em; margin-top: 5px;"></div>
          <select id="city-dropdown" class="form-select" required>
            <option value="" disabled selected>Select your city</option>
            <option value="Mumbai">Mumbai</option>
            <option value="Delhi">Delhi</option>
            <option value="Bangalore">Bangalore</option>
            <option value="Hyderabad">Hyderabad</option>
            <option value="Chennai">Chennai</option>
            <option value="Kolkata">Kolkata</option>
            <option value="Pune">Pune</option>
            <option value="Ahmedabad">Ahmedabad</option>
          </select>
          <button type="button" id="detect-location-btn" class="btn-secondary">
            <i class="fas fa-location-arrow"></i> Detect My Location
          </button>
        </div>
      </div>

      <div class="subscription__form" data-aos="fade-up">
        <input type="tel" id="signupPhone" placeholder="Enter Phone Number" required />
        <div id="recaptcha-container"></div>
        <button type="button" id="send-otp-btn">Get OTP</button>
      </div>
      
      <div class="subscription__form" data-aos="fade-up">
        <input type="text" id="otpInput" placeholder="Enter OTP" required disabled />
        <button type="button" id="verify-btn" disabled>Verify & Signup</button>
      </div>
      
      <p class="divider">or sign up with</p>
      
      <div class="subscription__form" data-aos="fade-up" style="flex-direction: column; align-items: stretch;">
        <button type="button" id="google-signin-btn">Google</button>
      </div>
    </div>
  </section>

  <footer class="footer flex-between">
    <h3 class="footer__logo"><span>GharVED</span>tan</h3>
    <ul class="footer__nav">
      <li><a href="../menu/menu.html">Menu</a></li>
      <li><a href="../addrestaurant.html">Work With Us</a></li>
      <li><a href="#about-us">About Us</a></li>
      <li><a href="#policies">Terms & Conditions</a></li>
    </ul>
  </footer>

  <script src=../dist/aos.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { 
      getAuth, 
      RecaptchaVerifier, 
      signInWithPhoneNumber, 
      GoogleAuthProvider, 
      signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDImyxdSlB0Yr0PdMx32nVccGt7n3zMWZw",
      authDomain: "gharvedtan-auth.firebaseapp.com",
      projectId: "gharvedtan-auth",
      storageBucket: "gharvedtan-auth.appspot.com",
      messagingSenderId: "32502650170",
      appId: "1:32502650170:web:8268b4c5947d5f04ab6c03"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // Global variables
    let confirmationResult = null;
    let recaptchaVerifier = null;
    let detectedLocationData = null;

    // DOM Elements
    const signupName = document.getElementById('signupName');
    const signupPass = document.getElementById('signupPass');
    const signupRepass = document.getElementById('signupRepass');
    const signupPhone = document.getElementById('signupPhone');
    const otpInput = document.getElementById('otpInput');
    const verifyBtn = document.getElementById('verify-btn');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const cityDropdown = document.getElementById('city-dropdown');
    const cityName = document.getElementById('city-name');
    const clearCityBtn = document.getElementById('clear-city-btn');
    const detectLocationBtn = document.getElementById('detect-location-btn');
    const locationDetails = document.getElementById('location-details');
    const googleSigninBtn = document.getElementById('google-signin-btn');

    // Initialize AOS animations
    AOS.init({
      duration: 1000,
      offset: 100,
    });

   
    function initializeRecaptcha() {
      recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
        size: 'invisible',
        callback: () => {
          sendOTP();
        }
      }, auth);
    }


    async function sendOTP() {
      const phone = signupPhone.value.trim();
      
      if (phone.length !== 10) {
        alert('Please enter a valid 10-digit phone number');
        return;
      }

      try {
        if (!recaptchaVerifier) {
          initializeRecaptcha();
        }

        const fullPhone = `+91${phone}`;
        confirmationResult = await signInWithPhoneNumber(auth, fullPhone, recaptchaVerifier);
        
        otpInput.disabled = false;
        verifyBtn.disabled = false;
        sendOtpBtn.textContent = 'Resend OTP';
        alert('OTP sent successfully!');
      } catch (error) {
        console.error('OTP Error:', error);
        alert(`Failed to send OTP: ${error.message}`);
      }
    }

    async function verifyOTP() {
      const otp = otpInput.value.trim();
      const name = signupName.value.trim();
      const phone = signupPhone.value.trim();
      const password = signupPass.value;
      const repass = signupRepass.value;
      const city = cityName.textContent === 'None' ? '' : cityName.textContent;

      if (!confirmationResult) {
        alert('Please send OTP first');
        return;
      }

      if (!name || !phone || !password || !repass || !city) {
        alert('All fields are required');
        return;
      }

      if (password !== repass) {
        alert('Passwords do not match');
        return;
      }

      try {
        const result = await confirmationResult.confirm(otp);
        const user = result.user;

        const userData = {
          name,
          phone,
          password,
          location: detectedLocationData || {
            display: city,
            coordinates: null,
            address: null
          },
          uid: user.uid,
          createdAt: new Date()
        };

        await setDoc(doc(db, 'users', user.uid), userData);
        
        sessionStorage.setItem('loggedInUser', JSON.stringify({
          name,
          phone,
          uid: user.uid,
          location: userData.location.display,
          coordinates: userData.location.coordinates
        }));

        alert('Signup successful!');
        window.location.href = '../index.html';
      } catch (error) {
        console.error('Verification Error:', error);
        alert(`OTP verification failed: ${error.message}`);
      }
    }

    async function googleSignIn() {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        const user = result.user;

        const userData = {
          name: user.displayName || 'Anonymous',
          phone: user.phoneNumber || 'Not provided',
          email: user.email || 'Not provided',
          location: detectedLocationData || {
            display: cityName.textContent === 'None' ? '' : cityName.textContent,
            coordinates: null,
            address: null
          },
          uid: user.uid,
          createdAt: new Date()
        };

        await setDoc(doc(db, 'users', user.uid), userData);

        sessionStorage.setItem('loggedInUser', JSON.stringify({
          name: userData.name,
          phone: userData.phone,
          email: userData.email,
          uid: user.uid,
          location: userData.location.display,
          coordinates: userData.location.coordinates
        }));

        alert('Google Sign-In successful!');
        window.location.href = '../index.html';
      } catch (error) {
        console.error('Google Sign-In Error:', error);
        alert('Google Sign-In failed. Please try again.');
      }
    }

    
    async function detectLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      detectLocationBtn.disabled = true;
      detectLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
      cityName.textContent = "Detecting your location...";

      try {
       
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            resolve, 
            reject, 
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            }
          );
        });

        const { latitude, longitude } = position.coords;
        

        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
        );
        
        if (!response.ok) throw new Error('Location service failed');
        
        const data = await response.json();
        const address = data.address;
        
     
        const addressComponents = [
          address.house_number,
          address.road,
          address.neighbourhood,
          address.suburb,
          address.city_district,
          address.city || address.town || address.village,
          address.state
        ].filter(Boolean);
        
        const locationText = addressComponents.join(', ') || "Your current location";
        
        
        detectedLocationData = {
          display: locationText,
          coordinates: { 
            latitude: latitude, 
            longitude: longitude,
            accuracy: position.coords.accuracy
          },
          address: address,
          timestamp: new Date()
        };
        
        
        cityName.textContent = locationText;
        cityDropdown.style.display = 'none';
        locationDetails.style.display = 'block';
        locationDetails.innerHTML = `
          <div>Latitude: ${latitude.toFixed(6)}</div>
          <div>Longitude: ${longitude.toFixed(6)}</div>
          <div>Accuracy: ${position.coords.accuracy.toFixed(2)} meters</div>
        `;
        
      } catch (error) {
        console.error("Location detection error:", error);
        cityName.textContent = "None";
        locationDetails.style.display = 'none';
        alert("Could not determine your location. Please try again or select manually.");
      } finally {
        detectLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Detect My Location';
        detectLocationBtn.disabled = false;
      }
    }

  
    function setupCitySelection() {
      cityDropdown.addEventListener('change', () => {
        cityName.textContent = cityDropdown.value;
        cityDropdown.style.display = 'none';
        locationDetails.style.display = 'none';
        detectedLocationData = null; 
      });

      clearCityBtn.addEventListener('click', () => {
        cityName.textContent = 'None';
        cityDropdown.style.display = 'block';
        locationDetails.style.display = 'none';
        detectedLocationData = null; 
      });
    }

    
    function setupFormValidation() {
      const validateForm = () => {
        const isFormValid = signupName.value.trim() && 
                          signupPass.value && 
                          signupRepass.value && 
                          signupPhone.value.trim().length === 10 &&
                          cityName.textContent !== 'None';
        
        sendOtpBtn.disabled = !isFormValid;
      };

      [signupName, signupPass, signupRepass, signupPhone].forEach(field => {
        field.addEventListener('input', validateForm);
      });

      signupPhone.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
      });

      validateForm();
    }

 
    document.addEventListener('DOMContentLoaded', () => {
      initializeRecaptcha();
      setupCitySelection();
      setupFormValidation();
      

      sendOtpBtn.addEventListener('click', sendOTP);
      verifyBtn.addEventListener('click', verifyOTP);
      googleSigninBtn.addEventListener('click', googleSignIn);
      detectLocationBtn.addEventListener('click', detectLocation);
    });
  </script>
</body>
</html>